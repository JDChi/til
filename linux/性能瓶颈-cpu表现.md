# 性能瓶颈-cpu表现
## CPU 使用率低而平均负载高
### 指标解析
直接原因在于不可中断睡眠态（D状态）的进程数较多
### 排查方法
大都是因为等待 IO 资源

有两种常见问题：
1. 磁盘读写请求过多导致大量 I/O 等待
   - 当进程需要读写请求时，CPU 会向内核发起读写文件请求，由内核执行读写操作，然后 CPU 会切换到其它进程或空闲，原本运行的进程会进入不可中断的睡眠状态
   - 如果该进程涉及大量的 I/O 操作，就可能导致不可中断睡眠状态的进程累积，而 CPU 又并不繁忙，就表现出了 CPU 使用率低而平均负载高 的情况

解决方法：
   - 使用 `vmstat 1` 观察系统资源的使用情况，尤其是 wa 列的值，如果超过 30%，说明等待 IO 严重，可能存在大量的磁盘读写，也可能磁盘本身性能差
   - 使用 `iostat -x -d` 观察磁盘的使用情况，确定存在瓶颈的磁盘
   - 使用 `pidstat -d 1` 观察进程的 IO 情况，确定存在瓶颈的进程

2. SQL 语句未使用索引或者存在死锁
因为数据是存在磁盘，而 SQL 未使用索引，再加上数据量过大，导致扫描的压力很大，进而引起 IO 阻塞

## CPU 使用率高且平均负载高
在这种情况下，平均负载高一般为连带反应,应重点观察前者。

### CPU sy 高
#### 指标解析
系统内核消耗了大量 CPU 资源，应着重排查内核线程或系统调用的性能问题

#### 排查方法
1. 用 `vmstat` 查看系统的上下文切换次数

```shell
# 关注 cs 这一列
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 0  0      0 560580  48208 3101864    0    0     2    68   37   22  0  0 99  0  0
```

2. 用 `pidstat -w` 观察进程的自愿上下文切换（cswch）和非自愿上下文切换（nvcswch）情况。
```shell
Linux 5.4.0-26-generic (jdchi) 	05/02/24 	_aarch64_	(2 CPU)

08:02:22      UID       PID   cswch/s nvcswch/s  Command
08:02:22        0         1      0.08      0.18  systemd
08:02:22        0         2      0.00      0.00  kthreadd
08:02:22        0         3      0.00      0.00  rcu_gp
```
自愿上下文切换是应用内部线程状态发生转换所致。

非自愿上下文切换是因线程被分配的时间片用完或执行优先级被调度器调度所致。

如果 cswch 过多，说明进程多在等待资源，可能存在 IO、内存等系统资源瓶颈。

如果 nvcswch 过多，说明 CPU 时间片竞争激烈，进程多是被系统强制调度，可能是应用线程数过多导致。可使用 `top` 等工具统计进程数和进程状态分布来佐证。

### CPU si 高
#### 指标解析
软中断消耗了大量的 CPU 资源，应着重排查内核中的中断服务

1. 通过 `watch -d cat /proc/softirqs` 查看中断次数的变化速率，将变化速率快的中断类型列为嫌疑对象
```shell
Every 2.0s: cat /proc/softirqs                                                                                                                                                         jdchi: Thu May  2 08:32:57 2024

                    CPU0       CPU1
          HI:          9          2
       TIMER:    4174380    2065364
      NET_TX:      90989     123402
      NET_RX:     111356     234757
       BLOCK:     167979      40537
    IRQ_POLL:          0          0
     TASKLET:        608        529
       SCHED:    4169553    2070093
     HRTIMER:          0          0
         RCU:     882964     910162
```
NET_TX 是发送网络数据包的软中断， NET_RX 是接收网络数据包的软中断。若它们的变化速率快，则通过`sar -n DEV` 查看网卡的网络数据包收发速率，然后对收发速率高的网卡，通过 tcpdump 抓包，分析数据包来源，如果为正常流量，则考虑硬件升级，反之应增加防御措施。

SCHED 为进程调度以及负载均衡引起的中断。如果 SCHED 的变化速率快，说明系统存在较多进程切换，进一步使用 `pidstat` 查看 nvcswch 的情况，若 nvcswch 较多，则可能存在 cpu 瓶颈。

### CPU us 高
#### 指标解析
应用进程消耗了大量的 CPU 资源，应着重排查应用进程的性能问题。
#### 排查方法
代码缺陷、内存问题、CPU 密集型等

1. 代码缺陷
例如“死循环”。

2. 内存问题
例如应用存在大量 GC

3. CPU 密集型
如序列化/反序列化，加密/解密等

